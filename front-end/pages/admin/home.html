<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style/admin/home.css "/>

    <title>Registro de Pontos</title>
    
  </head>
  <body>
    <!-- MAPA + MENU SUPERIOR -->
    <div id="mapa-container">
      <header>
        <img src="images/logo.png" class="logo" />

        <div class="header-icons">
          <img src="SVGS/user.svg" class="menu-icon"/>
          <img src="SVGS/hamburguer.svg" class="menu-hamburguer" />
        </div>
      </header>

      <div id="search-box">
        <img src="SVGS/lupa.svg" class="icon-left" />
        <input type="text" id="search" placeholder="Busque aqui..." />
        <img src="SVGS/mic.svg" class="icon-right" />
      </div>

      <div id="mapa">
      <img id="mira" src="SVGS/localizacao.svg" />
    </div>

    <!-- POP-UP 1: CADASTRO -->
    <div id="popup-cadastro" class="popup hidden">
      <div class="popup-box">
        <h1>CADASTRO DE PONTOS</h1>

        <label>Nome:</label>
        <input type="text" id="ponto-nome" class="campo" />

        <label>Insira sua imagem:</label>
        <div id="imagem-preview" class="preview">Tap to load</div>
        <input type="file" id="ponto-imagem" hidden />

        <button id="btn-importar">Importar Imagem</button>

        <label>Descrição / Curiosidades:</label>
        <textarea id="ponto-desc" class="campo-desc"></textarea>

        <button id="btn-salvar" class="salvar">Salvar Ponto</button>
      </div>
    </div>

    <!-- POP-UP 2: HISTÓRICO -->
    <div id="popup-historico" class="popup hidden">
      <div class="popup-box">
        <h1>Histórico de Pontos</h1>

        <ul id="lista-pontos"></ul>

        <button id="btn-voltar" class="voltar">Voltar ao mapa</button>
      </div>
    </div>

    <script>
      // INICIAR MAPA LEAFLET

      const iconeGrande = L.icon({
        iconUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png",
        iconSize: [45, 70],
        iconAnchor: [22, 70],
        popupAnchor: [1, -34],
      });

      const map = L.map("mapa").setView([-8.0476, -34.877], 10); // Recife

      // Limitar o mapa só para Pernambuco
      map.setMaxBounds([
        [-9.6, -41.5], // sudoeste de PE
        [-6.0, -32.0], // nordeste de PE
      ]);

      // Impedir zoom out exagerado (opcional)
      map.setMinZoom(8);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
      }).addTo(map);

      let pontos = JSON.parse(localStorage.getItem("pontos")) || [];

      let ultimoLat = null;
      let ultimoLng = null;

      // ABRIR POPUP DE CADASTRO AO CLICAR NO MAPA
      map.on("click", (e) => {
        ultimoLat = e.latlng.lat;
        ultimoLng = e.latlng.lng;

        document.getElementById("popup-cadastro").classList.remove("hidden");
      });

      // IMPORTAR IMAGEM
      document.getElementById("btn-importar").addEventListener("click", () => {
        document.getElementById("ponto-imagem").click();
      });

      document
        .getElementById("ponto-imagem")
        .addEventListener("change", (e) => {
          const file = e.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = () => {
            const preview = document.getElementById("imagem-preview");
            preview.style.backgroundImage = `url(${reader.result})`;
            preview.style.backgroundSize = "cover";
            preview.style.color = "transparent";
          };
          reader.readAsDataURL(file);
        });

      // SALVAR PONTO
      document.getElementById("btn-salvar").addEventListener("click", () => {
        const nome = document.getElementById("ponto-nome").value;
        const desc = document.getElementById("ponto-desc").value;
        const imgInput = document.getElementById("ponto-imagem");

        if (!nome || !desc || imgInput.files.length === 0) {
          alert("Preencha todos os campos!");
          return;
        }

        const reader = new FileReader();
        reader.onload = () => {
          const lat = ultimoLat;
          const lng = ultimoLng;

          fetch(
            `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`
          )
            .then((res) => res.json())
            .then((data) => {
              const endereco = data.display_name || "Local não encontrado";

              const novoPonto = {
                nome,
                desc,
                imagem: reader.result,
                local: endereco,
                data: new Date().toLocaleString(),
                lat,
                lng,
              };

              pontos.push(novoPonto);
              localStorage.setItem("pontos", JSON.stringify(pontos));

              L.marker([lat, lng], { icon: iconeGrande }).addTo(map);

              carregarHistorico();

              // trocar popups
              document.getElementById("popup-cadastro").classList.add("hidden");
              document
                .getElementById("popup-historico")
                .classList.remove("hidden");
            });
        };

        reader.readAsDataURL(imgInput.files[0]);
      });

      //  CARREGAR HISTÓRICO
      function carregarHistorico() {
        const lista = document.getElementById("lista-pontos");
        lista.innerHTML = "";

        pontos.forEach((p, index) => {
          const item = document.createElement("li");
          item.innerHTML = `
      <strong>${p.nome}</strong><br>
      Local: ${p.local}<br>
      Data: ${p.data}<br>
      <button class="btn-editar" onclick="editar(${index})">Editar</button>
      <button class="btn-remover" onclick="remover(${index})">Remover</button>
    `;
          lista.appendChild(item);
        });
      }

      carregarHistorico();

      //  EDITAR
      function editar(index) {
        const p = pontos[index];

        document.getElementById("ponto-nome").value = p.nome;
        document.getElementById("ponto-desc").value = p.desc;

        const preview = document.getElementById("imagem-preview");
        preview.style.backgroundImage = `url(${p.imagem})`;
        preview.style.backgroundSize = "cover";
        preview.style.color = "transparent";

        document.getElementById("popup-historico").classList.add("hidden");
        document.getElementById("popup-cadastro").classList.remove("hidden");

        pontos.splice(index, 1);
        localStorage.setItem("pontos", JSON.stringify(pontos));
      }

      // REMOVER
      function remover(index) {
        pontos.splice(index, 1);
        localStorage.setItem("pontos", JSON.stringify(pontos));
        carregarHistorico();
      }

      // VOLTAR AO MAPA
      document.getElementById("btn-voltar").addEventListener("click", () => {
        document.getElementById("popup-historico").classList.add("hidden");
      });
    </script>

  </body>
</html>
